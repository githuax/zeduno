<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #17a2b8;
            padding-bottom: 20px;
        }
        .report-title {
            color: #17a2b8;
            font-size: 28px;
            font-weight: bold;
            margin: 0;
        }
        .report-subtitle {
            color: #666;
            font-size: 14px;
            margin: 10px 0 0 0;
        }
        .company-info {
            margin-bottom: 15px;
        }
        .company-name {
            font-size: 20px;
            font-weight: bold;
            color: #17a2b8;
        }
        .report-period {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 30px;
            border-left: 5px solid #17a2b8;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .summary-card {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        .section {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }
        .section-title {
            font-size: 20px;
            color: #17a2b8;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 5px;
            overflow: hidden;
        }
        th {
            background-color: #17a2b8;
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #e9ecef;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #e3f2fd;
        }
        .number {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        .currency {
            color: #28a745;
        }
        .percentage {
            color: #17a2b8;
        }
        .insight-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8e9 100%);
            border-left: 5px solid #17a2b8;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .insight-title {
            color: #17a2b8;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .customer-segment {
            display: inline-block;
            padding: 5px 15px;
            margin: 5px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
        }
        .segment-vip { background-color: #ffd700; color: #333; }
        .segment-premium { background-color: #17a2b8; color: white; }
        .segment-regular { background-color: #28a745; color: white; }
        .segment-frequent { background-color: #ffc107; color: #333; }
        .segment-new { background-color: #6c757d; color: white; }
        .behavior-chart {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .behavior-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .behavior-item:last-child {
            border-bottom: none;
        }
        .behavior-bar {
            width: 200px;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .behavior-fill {
            height: 100%;
            background: linear-gradient(90deg, #17a2b8, #20c997);
            border-radius: 10px;
        }
        .rating-stars {
            color: #ffc107;
            font-size: 18px;
        }
        .rating-distribution {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .rating-bar {
            width: 150px;
            height: 15px;
            background-color: #e9ecef;
            margin: 0 10px;
            border-radius: 7px;
            overflow: hidden;
        }
        .rating-fill {
            height: 100%;
            background-color: #ffc107;
            border-radius: 7px;
        }
        
        @media print {
            body { margin: 0; }
            .page-break { page-break-before: always; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div class="report-header">
        <div class="company-info">
            <div class="company-name">{{companyInfo.name}}</div>
            {{#if companyInfo.address}}
            <div>{{companyInfo.address}}</div>
            {{/if}}
        </div>
        <h1 class="report-title">{{title}}</h1>
        {{#if subtitle}}
        <p class="report-subtitle">{{subtitle}}</p>
        {{/if}}
    </div>

    <div class="report-period">
        <strong>Report Period:</strong> {{formatDate data.filters.startDate}} to {{formatDate data.filters.endDate}}
        <br>
        <strong>Generated:</strong> {{formattedGeneratedAt}}
        <br>
        <strong>Generated by:</strong> {{generatedBy.userName}} ({{generatedBy.userRole}})
    </div>

    <!-- Summary Section -->
    <div class="section">
        <h2 class="section-title">Customer Analytics Summary</h2>
        <div class="summary-grid">
            <div class="summary-card">
                <h3>Total Customers</h3>
                <p class="value">{{formatNumber data.summary.totalCustomers}}</p>
            </div>
            <div class="summary-card">
                <h3>New Customers</h3>
                <p class="value">{{formatNumber data.summary.newCustomers}}</p>
            </div>
            <div class="summary-card">
                <h3>Returning Customers</h3>
                <p class="value">{{formatNumber data.summary.returningCustomers}}</p>
            </div>
            <div class="summary-card">
                <h3>Avg Orders/Customer</h3>
                <p class="value">{{formatNumber data.summary.avgOrdersPerCustomer}}</p>
            </div>
            <div class="summary-card">
                <h3>Avg Revenue/Customer</h3>
                <p class="value">{{formatCurrency data.summary.avgRevenuePerCustomer}}</p>
            </div>
            <div class="summary-card">
                <h3>Retention Rate</h3>
                <p class="value">{{formatPercent data.summary.customerRetentionRate}}</p>
            </div>
        </div>

        <div class="insight-box">
            <div class="insight-title">🎯 Key Customer Insights</div>
            <ul style="margin: 10px 0;">
                <li><strong>Customer Growth:</strong> {{formatPercent (divide data.summary.newCustomers data.summary.totalCustomers)}} of customers are new acquisitions</li>
                <li><strong>Loyalty Level:</strong> {{formatPercent data.summary.customerRetentionRate}} retention rate indicates {{#if (gt data.summary.customerRetentionRate 60)}}strong{{else}}{{#if (gt data.summary.customerRetentionRate 40)}}moderate{{else}}low{{/if}}{{/if}} customer loyalty</li>
                <li><strong>Revenue Distribution:</strong> Average customer value is {{formatCurrency data.summary.avgRevenuePerCustomer}}</li>
            </ul>
        </div>
    </div>

    <!-- Customer Segments -->
    {{#if data.segments}}
    <div class="section">
        <h2 class="section-title">Customer Segmentation Analysis</h2>
        <table>
            <thead>
                <tr>
                    <th>Segment</th>
                    <th>Customer Count</th>
                    <th>Total Revenue</th>
                    <th>Avg Order Value</th>
                    <th>Revenue %</th>
                </tr>
            </thead>
            <tbody>
                {{#each data.segments}}
                <tr>
                    <td>
                        <span class="customer-segment segment-{{lowercase this.segment}}">{{this.segment}}</span>
                    </td>
                    <td class="number">{{formatNumber this.customerCount}}</td>
                    <td class="number currency">{{formatCurrency this.totalRevenue}}</td>
                    <td class="number currency">{{formatCurrency this.avgOrderValue}}</td>
                    <td class="number percentage">{{formatPercent this.percentage}}</td>
                </tr>
                {{/each}}
            </tbody>
        </table>
        
        <div class="insight-box">
            <div class="insight-title">💡 Segmentation Insights</div>
            {{#each data.segments}}
            {{#if (gt this.percentage 30)}}
            <p><strong>{{this.segment}} customers</strong> represent {{formatPercent this.percentage}} of revenue with {{formatNumber this.customerCount}} customers.</p>
            {{/if}}
            {{/each}}
        </div>
    </div>
    {{/if}}

    <!-- Customer Behavior -->
    {{#if data.behavior}}
    <div class="section page-break">
        <h2 class="section-title">Customer Behavior Patterns</h2>
        
        <!-- Preferred Order Types -->
        {{#if data.behavior.preferredOrderType}}
        <div class="behavior-chart">
            <h4 style="margin-top: 0; color: #17a2b8;">🛍️ Preferred Order Types</h4>
            {{#each data.behavior.preferredOrderType}}
            <div class="behavior-item">
                <span><strong>{{this.type}}</strong> ({{formatNumber this.count}} orders)</span>
                <div>
                    <div class="behavior-bar">
                        <div class="behavior-fill" style="width: {{this.percentage}}%;"></div>
                    </div>
                    <span style="margin-left: 10px;">{{formatPercent this.percentage}}</span>
                </div>
            </div>
            {{/each}}
        </div>
        {{/if}}

        <!-- Preferred Payment Methods -->
        {{#if data.behavior.preferredPaymentMethod}}
        <div class="behavior-chart">
            <h4 style="margin-top: 0; color: #17a2b8;">💳 Preferred Payment Methods</h4>
            {{#each data.behavior.preferredPaymentMethod}}
            <div class="behavior-item">
                <span><strong>{{this.method}}</strong> ({{formatNumber this.count}} transactions)</span>
                <div>
                    <div class="behavior-bar">
                        <div class="behavior-fill" style="width: {{this.percentage}}%;"></div>
                    </div>
                    <span style="margin-left: 10px;">{{formatPercent this.percentage}}</span>
                </div>
            </div>
            {{/each}}
        </div>
        {{/if}}

        <!-- Peak Order Hours -->
        {{#if data.behavior.avgOrderTime}}
        <div class="behavior-chart">
            <h4 style="margin-top: 0; color: #17a2b8;">🕒 Peak Order Hours</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                {{#each data.behavior.avgOrderTime}}
                <div style="text-align: center; padding: 10px; background: {{#if (gt this.orderCount 20)}}#d4edda{{else}}#f8f9fa{{/if}}; border-radius: 5px;">
                    <div><strong>{{this.hour}}:00</strong></div>
                    <div style="font-size: 12px;">{{formatNumber this.orderCount}} orders</div>
                </div>
                {{/each}}
            </div>
        </div>
        {{/if}}
    </div>
    {{/if}}

    <!-- Top Customers -->
    {{#if data.topCustomers}}
    <div class="section">
        <h2 class="section-title">Top Valued Customers</h2>
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Customer Name</th>
                    <th>Total Orders</th>
                    <th>Total Spent</th>
                    <th>Avg Order Value</th>
                    <th>Last Order</th>
                </tr>
            </thead>
            <tbody>
                {{#each data.topCustomers}}
                <tr>
                    <td class="number">{{add @index 1}}</td>
                    <td><strong>{{this.customerName}}</strong></td>
                    <td class="number">{{formatNumber this.totalOrders}}</td>
                    <td class="number currency">{{formatCurrency this.totalSpent}}</td>
                    <td class="number currency">{{formatCurrency this.avgOrderValue}}</td>
                    <td>{{formatDate this.lastOrderDate}}</td>
                </tr>
                {{/each}}
            </tbody>
        </table>

        <div class="insight-box">
            <div class="insight-title">👑 VIP Customer Insights</div>
            {{#with (lookup data.topCustomers 0)}}
            <p>Top customer <strong>{{this.customerName}}</strong> has spent {{formatCurrency this.totalSpent}} across {{formatNumber this.totalOrders}} orders.</p>
            {{/with}}
            <p>Top 20 customers contribute significantly to overall revenue - consider VIP loyalty programs.</p>
        </div>
    </div>
    {{/if}}

    <!-- Customer Feedback -->
    {{#if data.customerFeedback}}
    <div class="section">
        <h2 class="section-title">Customer Satisfaction</h2>
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
            <div>
                <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #fff3cd, #d4edda); border-radius: 10px;">
                    <div style="font-size: 48px; color: #ffc107; margin-bottom: 10px;">
                        ⭐ {{data.customerFeedback.avgRating}}
                    </div>
                    <div style="font-size: 18px; font-weight: bold; color: #333;">Average Rating</div>
                    <div style="color: #666;">Based on {{formatNumber data.customerFeedback.totalReviews}} reviews</div>
                </div>
            </div>
            <div>
                <h4 style="margin-top: 0;">Rating Distribution</h4>
                {{#each data.customerFeedback.ratingDistribution}}
                <div class="rating-distribution">
                    <span style="width: 20px;">{{this.rating}}</span>
                    <span class="rating-stars">★</span>
                    <div class="rating-bar">
                        <div class="rating-fill" style="width: {{this.percentage}}%;"></div>
                    </div>
                    <span style="width: 60px;">{{formatNumber this.count}} ({{formatPercent this.percentage}})</span>
                </div>
                {{/each}}
            </div>
        </div>

        <div class="insight-box" style="margin-top: 20px;">
            <div class="insight-title">📊 Satisfaction Analysis</div>
            <p>Customer satisfaction score of {{data.customerFeedback.avgRating}}/5.0 indicates 
            {{#if (gt data.customerFeedback.avgRating 4.5)}}excellent{{else}}{{#if (gt data.customerFeedback.avgRating 4.0)}}very good{{else}}{{#if (gt data.customerFeedback.avgRating 3.5)}}good{{else}}needs improvement{{/if}}{{/if}}{{/if}} 
            service quality.</p>
        </div>
    </div>
    {{/if}}

    <!-- Recommendations -->
    <div class="section">
        <h2 class="section-title">🎯 Strategic Recommendations</h2>
        <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f1f8e9 100%); padding: 25px; border-radius: 10px; border-left: 5px solid #17a2b8;">
            <h4 style="color: #17a2b8; margin-top: 0;">Customer Retention & Growth Strategies:</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h5 style="color: #155724;">🎯 For New Customers:</h5>
                    <ul style="color: #155724; line-height: 1.8;">
                        <li>Implement welcome offers for first-time customers</li>
                        <li>Create onboarding experience to showcase popular items</li>
                        <li>Follow up with new customers after first order</li>
                    </ul>
                    
                    <h5 style="color: #155724;">💎 For VIP Customers:</h5>
                    <ul style="color: #155724; line-height: 1.8;">
                        <li>Launch exclusive VIP loyalty program</li>
                        <li>Offer early access to new menu items</li>
                        <li>Personalized service and special recognition</li>
                    </ul>
                </div>
                <div>
                    <h5 style="color: #155724;">📈 Growth Opportunities:</h5>
                    <ul style="color: #155724; line-height: 1.8;">
                        <li>Target peak hours ({{#each data.behavior.avgOrderTime}}{{#if (gt this.orderCount 30)}}{{this.hour}}:00 {{/if}}{{/each}}) for promotions</li>
                        <li>Promote less popular payment methods with incentives</li>
                        <li>Focus marketing on high-performing order types</li>
                    </ul>
                    
                    <h5 style="color: #155724;">⭐ Service Improvement:</h5>
                    <ul style="color: #155724; line-height: 1.8;">
                        {{#if (lt data.customerFeedback.avgRating 4.0)}}
                        <li>Address service quality issues (rating: {{data.customerFeedback.avgRating}}/5.0)</li>
                        {{/if}}
                        <li>Gather more feedback to improve satisfaction</li>
                        <li>Implement customer feedback loop system</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="footer" style="margin-top: 40px; text-align: center; color: #666; font-size: 12px; border-top: 1px solid #dee2e6; padding-top: 20px;">
        <p>This report was generated on {{formattedGeneratedAt}} by {{generatedBy.userName}}</p>
        <p>{{companyInfo.name}} - Customer Analytics Report</p>
        {{#if companyInfo.email}}
        <p>Contact: {{companyInfo.email}}</p>
        {{/if}}
    </div>
</body>
</html>